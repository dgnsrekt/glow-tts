# Go Code Style - Glow-TTS Project

> Coding standards aligned with the original Glow project structure
> Maintains consistency while allowing TTS feature isolation

## Project Structure

### Core Principle: Feature Isolation
Keep TTS features self-contained while following Glow's patterns:

```
/
├── main.go                 # Entry point (minimal TTS changes)
├── config_cmd.go          # Config command (extend for TTS settings)
├── tts/                   # NEW: All TTS-specific code
│   ├── tts.go            # TTS main controller
│   ├── engine.go         # TTS engine interface
│   ├── piper.go          # Piper TTS implementation
│   ├── google.go         # Google TTS implementation
│   ├── audio.go          # Audio playback system
│   ├── sentence.go       # Sentence parsing/tracking
│   └── sync.go           # Audio-visual synchronization
├── ui/                    # Existing UI (minimal changes)
│   ├── pager.go          # Extend with TTS highlighting
│   └── tts_status.go     # NEW: TTS status display
└── utils/                 # Shared utilities
```

### File Organization Rules

1. **Preserve Original Files**: Minimize changes to existing Glow files
2. **TTS Isolation**: Keep all TTS logic in `tts/` directory
3. **Interface Points**: Use clean interfaces between Glow and TTS
4. **UI Extensions**: Add new UI files rather than heavily modifying existing ones

## Code Style Guidelines

### Package Structure

```go
// Package header follows Glow convention
// Package tts provides text-to-speech functionality for Glow.
package tts

import (
    // Standard library imports first
    "context"
    "fmt"
    "io"
    
    // Third-party imports (grouped)
    "github.com/charmbracelet/bubbles/key"
    "github.com/charmbracelet/bubbletea"
    
    // Internal imports last
    "github.com/charmbracelet/glow/v2/ui"
)
```

### Naming Conventions

Follow Glow's existing patterns:

```go
// Types: CamelCase
type TTSEngine interface {}
type SentenceParser struct {}

// Interfaces: End with 'er' when possible
type Reader interface {}
type Speaker interface {}

// Constants: CamelCase (not SCREAMING_SNAKE)
const DefaultSpeechRate = 1.0
const MaxSentenceLength = 1000

// Errors: ErrPrefix
var ErrEngineNotAvailable = errors.New("tts engine not available")
var ErrAudioDeviceNotFound = errors.New("audio device not found")
```

### Bubble Tea Integration

Follow Glow's Model-Update-View pattern:

```go
// Extend existing models cleanly
type TTSState struct {
    Playing  bool
    Sentence int
    Engine   TTSEngine
}

// Commands follow tea.Cmd pattern
func playNextSentenceCmd() tea.Cmd {
    return func() tea.Msg {
        // Async operation
        return sentencePlayedMsg{}
    }
}

// Messages are simple types
type sentencePlayedMsg struct {
    index int
    error error
}
```

### Error Handling

Match Glow's graceful degradation approach:

```go
// Don't panic, return errors
engine, err := NewPiperEngine()
if err != nil {
    // Log and fallback
    log.Warn("Piper TTS unavailable", "error", err)
    return nil, ErrEngineNotAvailable
}

// Wrap errors with context
if err := engine.Speak(text); err != nil {
    return fmt.Errorf("speaking text: %w", err)
}
```

### Configuration Integration

Extend Viper config following Glow patterns:

```yaml
# In glow.yml
# Existing Glow settings...

# TTS Configuration (new section)
tts:
  enabled: true
  engine: "piper"  # or "google"
  voice: "default"
  rate: 1.0
  piper:
    binary: "piper"
    model: "en_US-lessac-medium"
  google:
    apiKey: ""
    language: "en-US"
```

```go
// Read config like Glow does
type TTSConfig struct {
    Enabled bool   `mapstructure:"enabled"`
    Engine  string `mapstructure:"engine"`
    Voice   string `mapstructure:"voice"`
    Rate    float64 `mapstructure:"rate"`
}

func loadTTSConfig() TTSConfig {
    var cfg TTSConfig
    viper.UnmarshalKey("tts", &cfg)
    return cfg
}
```

## Testing Standards

### Test File Organization

```go
// Follow Glow's test patterns
// tts/engine_test.go
package tts

import (
    "testing"
)

func TestPiperEngine(t *testing.T) {
    // Table-driven tests when appropriate
    tests := []struct {
        name string
        text string
        want error
    }{
        {"empty text", "", ErrEmptyText},
        {"valid text", "Hello world", nil},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Test implementation
        })
    }
}
```

## Interface Design

### Clean Boundaries

Define clear interfaces between Glow and TTS:

```go
// tts/interface.go
// Minimal interface that ui/pager.go can use
type TTSController interface {
    Start(content string) error
    Stop() error
    Pause() error
    Resume() error
    NextSentence() error
    PrevSentence() error
    GetState() TTSState
}

// Internal interfaces stay in tts package
type engine interface {
    speak(text string) ([]byte, error)
    configure(opts EngineOptions) error
}
```

## Documentation

### Package Documentation

```go
// Package tts implements text-to-speech functionality for Glow.
//
// The TTS system provides sentence-level synchronization between audio
// playback and visual highlighting in the terminal. It supports multiple
// TTS engines including Piper (local) and Google TTS (cloud).
//
// Basic usage:
//
//     controller := tts.New(config)
//     err := controller.Start(markdownContent)
//
package tts
```

### Function Documentation

```go
// NewController creates a new TTS controller with the given configuration.
// It will attempt to initialize the configured engine (Piper or Google TTS).
// If the engine is unavailable, it returns an error but Glow can continue
// without TTS functionality.
func NewController(cfg Config) (*Controller, error) {
    // Implementation
}
```

## Dependencies

### Adding New Dependencies

1. Minimize new dependencies
2. Prefer stdlib where possible
3. Use same libraries as Glow when applicable
4. Document why each dependency is needed

```go
// go.mod additions
require (
    // Audio playback (choose one)
    github.com/faiface/beep v1.1.0  // Cross-platform audio
    // or
    github.com/hajimehoshi/oto v1.0.1  // Lower-level audio
    
    // Only if needed for audio formats
    github.com/hajimehoshi/go-mp3 v0.3.4
)
```

## Build and Release

### Build Tags for Optional Features

```go
// +build tts

package tts

// TTS implementation
```

```go
// +build !tts

package tts

// Stub implementation
type Controller struct{}

func New(cfg Config) (*Controller, error) {
    return nil, errors.New("TTS support not compiled")
}
```

## Performance Guidelines

1. **Lazy Loading**: Don't initialize TTS until needed
2. **Async Operations**: Use goroutines for audio generation
3. **Buffering**: Pre-generate next sentence while current plays
4. **Resource Cleanup**: Always clean up audio resources

```go
// Good: Lazy initialization
func (c *Controller) ensureEngine() error {
    if c.engine == nil {
        engine, err := createEngine(c.config)
        if err != nil {
            return err
        }
        c.engine = engine
    }
    return nil
}

// Good: Proper cleanup
func (c *Controller) Close() error {
    if c.audio != nil {
        c.audio.Stop()
        c.audio.Close()
    }
    if c.engine != nil {
        c.engine.Shutdown()
    }
    return nil
}
```

## Git Workflow for TTS Development

### Branch Strategy

```bash
# Feature branches for TTS work
git checkout -b feature/tts-core
git checkout -b feature/tts-piper-engine  
git checkout -b feature/tts-ui-integration

# Keep changes focused
# One feature per branch
# Rebase on main/master regularly
```

### Commit Messages

Follow Glow's style:
```
Add TTS controller and engine interface

Implements the core TTS controller that manages text-to-speech
functionality. Includes abstract engine interface for multiple
TTS backends.

Part of #1 (TTS feature)
```

## Migration Path

### Phase 1: Core TTS (Isolated)
- All code in `tts/` directory
- No changes to existing files
- Basic audio playback working

### Phase 2: UI Integration (Minimal)
- Add `ui/tts_status.go` for status display
- Minimal changes to `ui/pager.go` for highlighting
- Add keyboard handlers to `ui/keys.go`

### Phase 3: Configuration
- Extend `config_cmd.go` for TTS settings
- Update Viper configuration schema
- Add TTS flags to main.go

### Phase 4: Polish
- Optimize performance
- Add comprehensive tests
- Update documentation

## Code Review Checklist

- [ ] Follows Glow's existing patterns
- [ ] TTS code is isolated in `tts/` directory
- [ ] Minimal changes to original Glow files
- [ ] Clean interfaces between components
- [ ] Proper error handling without panics
- [ ] Resources are properly cleaned up
- [ ] Tests follow Glow's testing patterns
- [ ] Documentation matches Glow's style
- [ ] No unnecessary dependencies added
- [ ] Performance impact is minimal